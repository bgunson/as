const express = require('express');
const { writeFile, readFile } = require('fs');
const app = express();
const http = require('http');
const server = http.createServer(app);
const { Server } = require("socket.io");
const io = new Server(server);
const os = require('os');

// cache of currently active (connected) servers i.e. peers
const peers = {};

app.get('/', (req, res) => {
  res.send("Welcome to adshare!\n\nWe are a distributed marketing platform where your ad will get noticed. Blah blah blah...");
});

app.get('/ad', (req, res) => {

    // choose random server
    const peerId = Object.keys(servers)[Math.random() * (Object.keys(servers).length-1)];
    
    // get the socket ref of the chosen server
    const socket = peers[peerId];

    if (!socket) {
        // no servers online
        //TODO: Proxy act as 'server' for some fault-tolerance #laterworry
        const trol = '\u2591\u2591\u2591\u2591\u2591\u2584\u2584\u2584\u2584\u2580\u2580\u2580\u2580\u2580\u2580\u2580\u2580\u2584\u2584\u2584\u2584\u2584\u2584\u2591\u2591\u2591\u2591\u2591\u2591\u2591\r\n\u2591\u2591\u2591\u2591\u2591\u2588\u2591\u2591\u2591\u2591\u2592\u2592\u2592\u2592\u2592\u2592\u2592\u2592\u2592\u2592\u2592\u2592\u2591\u2591\u2580\u2580\u2584\u2591\u2591\u2591\u2591\r\n\u2591\u2591\u2591\u2591\u2588\u2591\u2591\u2591\u2592\u2592\u2592\u2592\u2592\u2592\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2592\u2592\u2592\u2591\u2591\u2588\u2591\u2591\u2591\r\n\u2591\u2591\u2591\u2588\u2591\u2591\u2591\u2591\u2591\u2591\u2584\u2588\u2588\u2580\u2584\u2584\u2591\u2591\u2591\u2591\u2591\u2584\u2584\u2584\u2591\u2591\u2591\u2591\u2588\u2591\u2591\r\n\u2591\u2584\u2580\u2592\u2584\u2584\u2584\u2592\u2591\u2588\u2580\u2580\u2580\u2580\u2584\u2584\u2588\u2591\u2591\u2591\u2588\u2588\u2584\u2584\u2588\u2591\u2591\u2591\u2591\u2588\u2591\r\n\u2588\u2591\u2592\u2588\u2592\u2584\u2591\u2580\u2584\u2584\u2584\u2580\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2588\u2591\u2591\u2591\u2592\u2592\u2592\u2592\u2592\u2591\u2588\r\n\u2588\u2591\u2592\u2588\u2591\u2588\u2580\u2584\u2584\u2591\u2591\u2591\u2591\u2591\u2588\u2580\u2591\u2591\u2591\u2591\u2580\u2584\u2591\u2591\u2584\u2580\u2580\u2580\u2584\u2592\u2588\r\n\u2591\u2588\u2591\u2580\u2584\u2591\u2588\u2584\u2591\u2588\u2580\u2584\u2584\u2591\u2580\u2591\u2580\u2580\u2591\u2584\u2584\u2580\u2591\u2591\u2591\u2591\u2588\u2591\u2591\u2588\u2591\r\n\u2591\u2591\u2588\u2591\u2591\u2591\u2580\u2584\u2580\u2588\u2584\u2584\u2591\u2588\u2580\u2580\u2580\u2584\u2584\u2584\u2584\u2580\u2580\u2588\u2580\u2588\u2588\u2591\u2588\u2591\u2591\r\n\u2591\u2591\u2591\u2588\u2591\u2591\u2591\u2591\u2588\u2588\u2591\u2591\u2580\u2588\u2584\u2584\u2584\u2588\u2584\u2584\u2588\u2584\u2588\u2588\u2588\u2588\u2591\u2588\u2591\u2591\u2591\r\n\u2591\u2591\u2591\u2591\u2588\u2591\u2591\u2591\u2591\u2580\u2580\u2584\u2591\u2588\u2591\u2591\u2591\u2588\u2591\u2588\u2580\u2588\u2588\u2588\u2588\u2588\u2588\u2591\u2588\u2591\u2591\r\n\u2591\u2591\u2591\u2591\u2591\u2580\u2584\u2591\u2591\u2591\u2591\u2591\u2580\u2580\u2584\u2584\u2584\u2588\u2584\u2588\u2584\u2588\u2584\u2588\u2584\u2580\u2591\u2591\u2588\u2591\u2591\r\n\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2580\u2584\u2584\u2591\u2592\u2592\u2592\u2592\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2592\u2591\u2591\u2591\u2588\u2591\r\n\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2580\u2580\u2584\u2584\u2591\u2592\u2592\u2592\u2592\u2592\u2592\u2592\u2592\u2592\u2592\u2591\u2591\u2591\u2591\u2588\u2591\r\n\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2580\u2584\u2584\u2584\u2584\u2584\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2588\u2591\u2591';
                console.log(trol);
                res.send(trol);
        return;
    }
    
    //Each time client refreshes, need new ad!
    socket.emit("get-ad");  // tell them (server(s))we want an ad

    // wait for the stream
    socket.once("upload-ad", (id, stream) => {
        // cache the file on the fs on proxy machine
        //os.tmpdir()->Returns the operating system's default directory for temporary files as a string.
        const rcvdAdFile = `${os.tmpdir()}/adshare-${id}`;
        const rcvdAdFileName = id; 
        //const fileName = file.name;
        writeFile(rcvdAdFile, stream, {}, (err) => {
            if (!err) {
                console.log("Received ad: " + rcvdAdFileName + " from server!");
                console.log("Caching ad: " + rcvdAdFileName + "to : " + os.tmpdir()  +" !");
                res.sendFile(rcvdAdFile);
            } else {
                const trol = '\u2591\u2591\u2591\u2591\u2591\u2584\u2584\u2584\u2584\u2580\u2580\u2580\u2580\u2580\u2580\u2580\u2580\u2584\u2584\u2584\u2584\u2584\u2584\u2591\u2591\u2591\u2591\u2591\u2591\u2591\r\n\u2591\u2591\u2591\u2591\u2591\u2588\u2591\u2591\u2591\u2591\u2592\u2592\u2592\u2592\u2592\u2592\u2592\u2592\u2592\u2592\u2592\u2592\u2591\u2591\u2580\u2580\u2584\u2591\u2591\u2591\u2591\r\n\u2591\u2591\u2591\u2591\u2588\u2591\u2591\u2591\u2592\u2592\u2592\u2592\u2592\u2592\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2592\u2592\u2592\u2591\u2591\u2588\u2591\u2591\u2591\r\n\u2591\u2591\u2591\u2588\u2591\u2591\u2591\u2591\u2591\u2591\u2584\u2588\u2588\u2580\u2584\u2584\u2591\u2591\u2591\u2591\u2591\u2584\u2584\u2584\u2591\u2591\u2591\u2591\u2588\u2591\u2591\r\n\u2591\u2584\u2580\u2592\u2584\u2584\u2584\u2592\u2591\u2588\u2580\u2580\u2580\u2580\u2584\u2584\u2588\u2591\u2591\u2591\u2588\u2588\u2584\u2584\u2588\u2591\u2591\u2591\u2591\u2588\u2591\r\n\u2588\u2591\u2592\u2588\u2592\u2584\u2591\u2580\u2584\u2584\u2584\u2580\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2588\u2591\u2591\u2591\u2592\u2592\u2592\u2592\u2592\u2591\u2588\r\n\u2588\u2591\u2592\u2588\u2591\u2588\u2580\u2584\u2584\u2591\u2591\u2591\u2591\u2591\u2588\u2580\u2591\u2591\u2591\u2591\u2580\u2584\u2591\u2591\u2584\u2580\u2580\u2580\u2584\u2592\u2588\r\n\u2591\u2588\u2591\u2580\u2584\u2591\u2588\u2584\u2591\u2588\u2580\u2584\u2584\u2591\u2580\u2591\u2580\u2580\u2591\u2584\u2584\u2580\u2591\u2591\u2591\u2591\u2588\u2591\u2591\u2588\u2591\r\n\u2591\u2591\u2588\u2591\u2591\u2591\u2580\u2584\u2580\u2588\u2584\u2584\u2591\u2588\u2580\u2580\u2580\u2584\u2584\u2584\u2584\u2580\u2580\u2588\u2580\u2588\u2588\u2591\u2588\u2591\u2591\r\n\u2591\u2591\u2591\u2588\u2591\u2591\u2591\u2591\u2588\u2588\u2591\u2591\u2580\u2588\u2584\u2584\u2584\u2588\u2584\u2584\u2588\u2584\u2588\u2588\u2588\u2588\u2591\u2588\u2591\u2591\u2591\r\n\u2591\u2591\u2591\u2591\u2588\u2591\u2591\u2591\u2591\u2580\u2580\u2584\u2591\u2588\u2591\u2591\u2591\u2588\u2591\u2588\u2580\u2588\u2588\u2588\u2588\u2588\u2588\u2591\u2588\u2591\u2591\r\n\u2591\u2591\u2591\u2591\u2591\u2580\u2584\u2591\u2591\u2591\u2591\u2591\u2580\u2580\u2584\u2584\u2584\u2588\u2584\u2588\u2584\u2588\u2584\u2588\u2584\u2580\u2591\u2591\u2588\u2591\u2591\r\n\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2580\u2584\u2584\u2591\u2592\u2592\u2592\u2592\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2592\u2591\u2591\u2591\u2588\u2591\r\n\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2580\u2580\u2584\u2584\u2591\u2592\u2592\u2592\u2592\u2592\u2592\u2592\u2592\u2592\u2592\u2591\u2591\u2591\u2591\u2588\u2591\r\n\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2580\u2584\u2584\u2584\u2584\u2584\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2588\u2591\u2591';
                console.log(trol);
                res.send(err);
            }
        });
        
    });
    

});

io.on("connection", (socket) => {

    console.log(`${socket.id} is now part of the Swarm!`);
    // store a reference to this server's socket. (note servers are just socket.io clients)
    peers[socket.id] = socket;

    socket.on("disconnect", () => {
        console.log(`${socket.id} has been exiled from the Swarm (for now!)`)
        // this server disconected, remove from local cache so they wont be picked next time a client hails an ad
        delete peers[socket.id];
        io.emit("give-peer-list", Object.keys(peers));
    });

        socket.on("replicate", (ad) => {
        // TODO: choose another peer to be replicated to
    });

    socket.on("get-peer-list", () => {
        io.emit("give-peer-list", Object.keys(peers));
    });

});


server.listen(process.env.PORT || 3000, () => {
  console.log('live @ *:3000');
});